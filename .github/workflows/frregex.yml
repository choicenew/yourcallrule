name: FR Regex Daily Data Processing

on:
  schedule:
    - cron: '0 1 * * 3' # Run every Wednesday at 1:00 AM (UTC)
  workflow_dispatch:

jobs:
  process_data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # ✅ 核心修正：像 US FCC 示例一样，明确指定要操作的分支
      - uses: actions/checkout@v4
        with:
          ref: fr
          fetch-depth: 0

      - name: Download Begone List
        run: wget https://raw.githubusercontent.com/oulixalt/BegoneListeFR/refs/heads/Liste-compl%C3%A8te/Begone-FR.xml -O begone.xml

      - name: Parse XML and generate CSV
        run: |
          sudo apt-get update && sudo apt-get install -y libxml2-utils
          OUTPUT_CSV="processed_fr_regex.csv"
          echo "id,name,priority,action,pattern,isEnabled,subscriptionId,ruleType" > $OUTPUT_CSV
          xmllint --xpath "//dict/key[text()='number']/following-sibling::string[1]/text()" begone.xml | \
          while read number; do
            pattern=$(echo "$number" | sed 's/+//g; s/#/.*/g; s/^/33/; s/$/$/')
            id="$pattern"
            name="Block numbers matching ${pattern%?}"
            priority=3
            action="block"
            isEnabled=1
            subscriptionId="begone-fr-regex"
            ruleType="regex"
            echo "\"$id\",\"$name\",$priority,\"$action\",\"$pattern\",$isEnabled,\"$subscriptionId\",\"$ruleType\"" >> $OUTPUT_CSV
          done
          echo "Successfully generated $OUTPUT_CSV"

      # ✅ 核心修正：使用与 US FCC 示例完全相同的标准 commit-and-push 步骤
      - name: Commit Processed CSV
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update processed FR regex data"
          file_pattern: "processed_fr_regex.csv"
          repository: .
          token: ${{ secrets.GITHUB_TOKEN }}
