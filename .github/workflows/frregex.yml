name: FR Regex Daily Data Processing

on:
  schedule:
    # 注意：定时任务会默认在你的仓库的 "Default branch" (通常是 main) 上运行
    - cron: '0 1 * * 3'
  workflow_dispatch:

jobs:
  process_data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # ✅✅✅ 最终、绝对正确的修正：彻底移除 'ref'，让工作流在它所在的任何分支上运行
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Begone List
        run: wget https://raw.githubusercontent.com/oulixalt/BegoneListeFR/refs/heads/Liste-compl%C3%A8te/Begone-FR.xml -O begone.xml

      - name: Parse XML and generate CSV
        run: |
          sudo apt-get update && sudo apt-get install -y libxml2-utils
          OUTPUT_CSV="processed_fr_regex.csv"
          echo "id,name,priority,action,pattern,isEnabled,subscriptionId,ruleType" > $OUTPUT_CSV
          xmllint --xpath "//dict/key[text()='number']/following-sibling::string[1]/text()" begone.xml | \
          while read number; do
            pattern=$(echo "$number" | sed 's/+//g; s/#/.*/g; s/^/33/; s/$/$/')
            id="$pattern"
            name="Block numbers matching ${pattern%?}"
            priority=3
            action="block"
            isEnabled=1
            subscriptionId="begone-fr-regex"
            ruleType="regex"
            echo "\"$id\",\"$name\",$priority,\"$action\",\"$pattern\",$isEnabled,\"$subscriptionId\",\"$ruleType\"" >> $OUTPUT_CSV
          done
          echo "Successfully generated $OUTPUT_CSV"

      - name: Commit Processed CSV
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update processed FR regex data"
          file_pattern: "processed_fr_regex.csv"
          repository: .
          token: ${{ secrets.GITHUB_TOKEN }}
